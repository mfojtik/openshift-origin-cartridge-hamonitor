#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

export HAPROXY_STATS_APP_DIR=${OPENSHIFT_HAMONITOR_DIR}usr/app
export GEM_HOME=${OPENSHIFT_HAMONITOR_DIR}gems
export PATH=${PATH}:${GEM_HOME}/bin

function start() {
  echo "Starting HAProxyStats"
  scl enable ruby193 "puma --bind 'tcp://${OPENSHIFT_HAMONITOR_IP}:${OPENSHIFT_HAMONITOR_PORT}' \
    --daemon --dir ${HAPROXY_STATS_APP_DIR} --environment production \
    --pidfile ${OPENSHIFT_HAMONITOR_DIR}run/puma.pid \
    ${HAPROXY_STATS_APP_DIR}/config.ru"
}

function stop() {
  echo "Stopping HAProxyStats"
  scl enable ruby193 "pumactl --pid ${OPENSHIFT_HAMONITOR_DIR}run/puma.pid stop"
}

function restart() {
  echo "Restarting HAProxyStats"
  scl enable ruby193 "pumactl --pid ${OPENSHIFT_HAMONITOR_DIR}run/puma.pid restart"
}

function isrunning() {
  scl enable ruby193 "pumactl --pid ${OPENSHIFT_HAMONITOR_DIR}run/puma.pid status"
}

case "$1" in
    start)
        start
    ;;
    stop)
        stop
    ;;
    restart)
        stop
        start
    ;;
    status)
        if isrunning
        then
            client_result "HAProxyStats is running"
        else
            client_result "HAPRoxyStats is stopped"
        fi
        exit 0
    ;;
esac
